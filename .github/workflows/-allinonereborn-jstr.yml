name: Update allinonenorn-jstr.m3u

on:
  schedule:
    - cron: "0 * * * *"   # every 1 hour
  workflow_dispatch:

permissions:
  contents: write        # allow commit & push
  actions: read
  checks: read
  deployments: read
  issues: read
  pull-requests: read
  repository-projects: read
  statuses: read

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate M3U playlist
        env:
          SOURCE_URL: ${{ secrets.JSTR_SOURCE_URL }}
        run: |
          node << 'EOF'
          const fs = require("fs");
          const https = require("https");

          const URL = process.env.SOURCE_URL;
          const OUTPUT = "allinonenorn-jstr.m3u";

          if (!URL) {
            console.error("SOURCE_URL secret not set");
            process.exit(1);
          }

          function fetchJSON(url) {
            return new Promise((resolve, reject) => {
              https.get(url, res => {
                let data = "";
                res.on("data", d => data += d);
                res.on("end", () => resolve(JSON.parse(data)));
              }).on("error", reject);
            });
          }

          (async () => {
            const channels = await fetchJSON(URL);
            let m3u = "#EXTM3U\n\n";

            channels.forEach(ch => {
              if (!ch.mpd) return;

              const name = ch.name || "Unknown";
              const logo = ch.logo || "";
              const group = ch.category || "General";
              const ua = ch.userAgent || "";
              const ref = ch.referer || "";

              let stream = ch.mpd;
              if (ch.token) stream += "?" + ch.token;

              m3u += `#EXTINF:-1 tvg-name="${name}" tvg-logo="${logo}" group-title="${group}",${name}\n`;
              m3u += `${stream}|user-agent=${ua}|referer=${ref}\n\n`;
            });

            fs.writeFileSync(OUTPUT, m3u);
            console.log("Playlist generated successfully");
          })();
          EOF

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add allinonenorn-jstr.m3u
          git commit -m "Auto update allinonenorn-jstr.m3u" || echo "No changes to commit"
          git push
