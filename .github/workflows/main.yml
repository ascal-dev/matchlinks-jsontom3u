name: Generate Cricket M3U

permissions:
  contents: write

on:
  schedule:
    - cron: "0 * * * *"   # every 1 hour
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests

      - name: Fetch secret JSON and convert to M3U
        env:
          JSON_URL: ${{ secrets.ALTERNATE_JSON_URL }}
        run: |
          python << EOF
          import requests, os

          url = os.environ.get("JSON_URL")
          if not url:
              raise RuntimeError("JSON_URL secret is missing")

          OUTPUT = "Cricket.m3u"

          response = requests.get(url, timeout=30)
          response.raise_for_status()
          data = response.json()

          USER_AGENT = "StreamFlex/7.1.3 (Linux;Android 13) StreamFlex/69.1 ExoPlayerLib/824.0"

          lines = ["#EXTM3U"]

          tvg_id = 1

          for category, channels in data.items():
              if not isinstance(channels, dict):
                  continue

              for name, info in channels.items():
                  if not isinstance(info, dict):
                      continue

                  mpd = info.get("url")
                  if not mpd:
                      continue

                  key_id = info.get("keyId")
                  key = info.get("key")

                  logo = info.get("logo")
                  if not logo:
                      logo = "null"

                  lines.append(
                      f'#EXTINF:-1 tvg-logo="{logo}" tvg-id="{tvg_id}" group-title="Cricket",{name}'
                  )

                  if key_id and key:
                      lines.append("#KODIPROP:inputstream.adaptive.license_type=clearkey")
                      lines.append(
                          f"#KODIPROP:inputstream.adaptive.license_key={key_id}:{key}"
                      )

                  lines.append(f"#EXTVLCOPT:http-user-agent={USER_AGENT}")
                  lines.append('#EXTHTTP:{"cookie":""}')
                  lines.append(mpd)
                  lines.append("")

                  tvg_id += 1

          with open(OUTPUT, "w", encoding="utf-8") as f:
              f.write("\n".join(lines))

          print("Cricket.m3u generated successfully")
          EOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add Cricket.m3u
          git diff --cached --quiet || git commit -m "Auto-update Cricket.m3u"
          git push
