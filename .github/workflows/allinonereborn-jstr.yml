name: allinonenorn-jstr.m3u

on:
  schedule:
    - cron: "0 * * * *"   # every 1 hour
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Generate M3U
        env:
          SOURCE_URL: ${{ secrets.JSTR_SOURCE_URL }}
        run: |
          node << 'EOF'
          const fs = require("fs");
          const https = require("https");

          const URL = process.env.SOURCE_URL;
          const OUT = "allinonenorn-jstr.m3u";

          if (!URL) {
            console.error("JSTR_SOURCE_URL secret is missing");
            process.exit(1);
          }

          function fetchJSON(url) {
            return new Promise((resolve, reject) => {
              https.get(url, res => {
                let data = "";
                res.on("data", d => data += d);
                res.on("end", () => resolve(JSON.parse(data)));
              }).on("error", reject);
            });
          }

          (async () => {
            const data = await fetchJSON(URL);

            let m3u = '#EXTM3U x-tvg-url="https://avkb.short.gy/jioepg.xml.gz"\n\n';

            data.forEach(ch => {
              if (!ch.mpd || !ch.drm || Object.keys(ch.drm).length === 0) return;

              const kid = Object.keys(ch.drm)[0];
              const key = ch.drm[kid];
              const cookie = ch.token;
              const name = ch.name;
              const logo = ch.logo;
              const group = ch.category;
              const id = ch.channel_id || "";

              const url =
                ch.mpd +
                "?" +
                cookie +
                "&xxx=%7Ccookie=" +
                cookie;

              m3u += `#EXTINF:-1 tvg-logo="${logo}" tvg-id="${id}" group-title="${group}",${name}\n`;
              m3u += `#KODIPROP:inputstream.adaptive.license_type=clearkey\n`;
              m3u += `#KODIPROP:inputstream.adaptive.license_key=${kid}:${key}\n`;
              m3u += `#EXTVLCOPT:http-user-agent=StreamFlex/7.1.3 (Linux;Android 13) StreamFlex/69.1 ExoPlayerLib/824.0\n`;
              m3u += `#EXTHTTP:{"cookie":"${cookie}"}\n`;
              m3u += `${url}\n\n`;
            });

            fs.writeFileSync(OUT, m3u);
            console.log("M3U generated successfully");
          })();
          EOF

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add allinonenorn-jstr.m3u
          git commit -m "Auto update allinonenorn-jstr.m3u" || echo "No changes"
          git push
