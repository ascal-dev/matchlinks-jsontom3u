name: Convert MPD Repo to M3U

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download source file
        env:
          SRC_URL: ${{ secrets.SOURCE_RAW_URL }}
        run: |
          curl -L "$SRC_URL" -o source.txt

      - name: Convert to M3U (dedupe + DRM rules)
        run: |
          echo "#EXTM3U" > final.m3u

          awk '
          BEGIN {
            channel=""
            url=""
            key=""
            seen_count=0
          }

          function is_m3u8(u) {
            return (u ~ /^https:\/\// && u ~ /\.m3u8$/)
          }

          /^#EXTINF/ {
            channel=$0
            sub(/.*?,/, "", channel)
            next
          }

          /^#KODIPROP:inputstream.adaptive.license_key/ {
            key=$0
            sub(/.*=/, "", key)
            next
          }

          /^https?:\/\// {
            url=$0

            # default channel
            if (channel == "") channel="null"

            # dedupe by channel name
            if (seen[channel]++) {
              channel=""; key=""; next
            }

            # rule: keep https + m3u8 even without DRM
            if (is_m3u8(url)) {
              print "#EXTINF:-1 tvg-id=\"1069\" group-title=\"Education\" tvg-logo=\"https://jiotv.catchup.cdn.jio.com/dare_images/images/Vande_Gujarat_1.png\"," channel >> "final.m3u"
              print "#EXTVLCOPT:http-user-agent=plaYtv/7.1.3 (Linux;Android 13) ygx/824.1 ExoPlayerLib/824.0" >> "final.m3u"
              print "#EXTHTTP:{\"cookie\":\"\"}" >> "final.m3u"
              print url "\n" >> "final.m3u"
              channel=""; key=""
              next
            }

            # rule: DRM must exist
            if (key == "") {
              channel=""; next
            }

            print "#EXTINF:-1 tvg-id=\"1069\" group-title=\"Education\" tvg-logo=\"https://jiotv.catchup.cdn.jio.com/dare_images/images/Vande_Gujarat_1.png\"," channel >> "final.m3u"
            print "#KODIPROP:inputstream.adaptive.license_type=clearkey" >> "final.m3u"
            print "#KODIPROP:inputstream.adaptive.license_key=" key >> "final.m3u"
            print "#EXTVLCOPT:http-user-agent=plaYtv/7.1.3 (Linux;Android 13) ygx/824.1 ExoPlayerLib/824.0" >> "final.m3u"
            print "#EXTHTTP:{\"cookie\":\"__hdnea__=st=1771011362~exp=1771097762~acl=/*\"}" >> "final.m3u"
            print url "\n" >> "final.m3u"

            channel=""
            key=""
          }
          ' source.txt

      - name: Commit output
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add final.m3u
          git commit -m "Auto convert MPD repo to M3U (deduped + DRM rules)" || echo "No changes"
          git push
